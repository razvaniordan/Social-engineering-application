<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sending profiles</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/SendingProfiles/SendingProfiles.css">
</head>
<body>
    <div class="wrapper">
        <form action="">
            <h1>
                Sending profiles
                <button id="btnHome" type="button" class="btn btn-light" onclick="home()">Home</button>
            </h1>

            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProfileModal">
                Create profile
            </button>

            <div class="modal fade" id="addProfileModal" tabindex="-1" aria-labelledby="addProfileModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addProfileModalLabel">Add New Profile</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="modalProfileName">Name</label>
                                <input type="text" id="modalProfileName" class="form-control" placeholder="Profile name">
                            </div>
                            <div class="form-group">
                                <label for="modalSmptFrom">SMTP From</label>
                                <input type="text" id="modalSmtpFrom" class="form-control" placeholder="Name <test@example.com>">
                            </div>
                            <div class="form-group">
                                <label for="modalHost">Host</label>
                                <input type="text" id="modalHost" class="form-control" placeholder="smtp.example.com:25">
                            </div>
                            <div class="form-group">
                                <label for="modalUsername">Username</label>
                                <input type="text" id="modalUsername" class="form-control" placeholder="Username">
                            </div>
                            <div class="form-group">
                                <label for="modalPassword">Password</label>
                                <input type="password" id="modalPassword" class="form-control" placeholder="Password">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showPasswordCheckbox">
                                    <label class="form-check-label" for="showPasswordCheckbox">
                                        Show Password
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success" onclick="addProfile()">Add profile</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="messageDisplay" class="alert" style="display: none;"></div>
            
        
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            refreshToken().then(() => {
                // After successfully refreshing the token, display the content and load data:
                document.querySelector('.wrapper').style.display = 'block';
            }).catch(() => {
                // If the token refresh fails, redirect to the login page:
                logout(true);
            });
        });

        function home() {
            window.location.href = '/home';
        }

        document.getElementById('showPasswordCheckbox').addEventListener('change', function () {
            const passwordInput = document.getElementById('modalPassword');
            if (this.checked) {
                passwordInput.type = 'text';
            } else {
                passwordInput.type = 'password';
            }
        });

        function refreshToken() {
            return fetch('/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTTP status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken); // Update the stored access token
                    return data.accessToken;
                } else {
                    throw new Error('Missing access token');
                }
            })
            .catch(error => {
                localStorage.removeItem('accessToken'); // Clear invalid or expired tokens
                throw error; // Rethrow the error for the next catch block
            });
        }

        function logout(failedAuth = false) {
            if (failedAuth) {
                alert('Session expired, please login again.');
            }
            // Here we send a request to the server to remove the refresh token from the database
            fetch('/logout', {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ token: refreshToken })
            }).then(() => {
                localStorage.removeItem('accessToken');
                window.location.href = '/'; // Redirect to the login page
            }).catch(error => {
                console.error('Error invalidating refresh token:', error);
            });
        }

        function showMessage(message, type) {
            const messageDisplay = document.getElementById('messageDisplay');
            messageDisplay.textContent = message; // Set the text of the message display area
            messageDisplay.style.display = 'block'; // Make the message display area visible
            messageDisplay.className = `alert alert-${type}`;
        }

        function addProfile() {
            const name = document.getElementById('modalProfileName').value;
            const smtpFrom = document.getElementById('modalSmtpFrom').value;
            const host = document.getElementById('modalHost').value;
            const username = document.getElementById('modalUsername').value;
            const password = document.getElementById('modalPassword').value;

            const hostRegex = /^(smtp\.[a-zA-Z0-9-]+\.[a-zA-Z]{2,6}):(\d{1,5})$/;

            if (!hostRegex.test(host)) {
                showMessage('Invalid host format. Please use the format "smtp.example.com:25"', 'danger');
                var modalElement = document.getElementById('addProfileModal');
                var modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
                return;
            }

            const sendAddProfileRequest = (token) => {
                fetch('/addSendingProfile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, smtpFrom, host, username, password }),
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 401 || response.status === 403) { // Unauthorized, so try to refresh the token
                        console.error('Token expired. Attempting to refresh token...');
                        throw new Error('Token expired or invalid'); // if we get this error
                    } else if (response.status === 400) {
                        throw new Error('The filling of all fields is required!');
                    } else if (response.status === 409) {
                        return response.json();
                    }
                })
                .then(data => {
                    showMessage(data.message, 'danger');
                    if (data.message.includes('Sending profile added')) {
                        messageDisplay.className = 'alert alert-success';
                        var modalElement = document.getElementById('addProfileModal');
                        var modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                })
                .catch(error => {
                    if (error.message === 'Token expired or invalid') { // we will begin this part of code and refresh the token
                        refreshToken().then(newToken => {
                            sendAddProfileRequest(newToken); // try to send the request again with the new token
                            console.log('Token refreshed successfully!');
                        }).catch(error => {
                            showMessage('Failed to refresh token. Please log in again.', 'danger');
                            logout(true); // redirect to the login page and logout
                        });
                    } else {
                        showMessage(error.message, 'danger');
                    }
                });
            }

            sendAddProfileRequest(localStorage.getItem('accessToken'));
        }

    </script>
    
</body>
</html>